<!-- 9929d37a-aea8-4fc8-a277-b5ff4f68851b adc07322-0d89-42af-b82c-f27499661004 -->
# План реализации режима групповых чатов с предзагрузкой кеша

## Цель

Реализовать систему управления кешем для больших групповых чатов, где персонажей больше, чем доступных слотов. При генерации ответа персонажа, не прикрепленного к слоту, автоматически загружается его последний сохраненный кеш.

## Основные компоненты

### 1. Система отслеживания персонажей по слотам

- **Файл**: `index.js`
- **Действия**:
- Добавить в `defaultSettings` настройку `groupChatMode: false`
- Реализовать функции из `slot-manager-example.js`:
- `initializeSlots(totalSlots)` - инициализация массивов слотов
- `acquireSlot(characterName)` - получение слота для персонажа (по частоте использования)
- `releaseSlot(slotIndex)` - освобождение слота
- `updateSlotsAvailability()` - обновление UI с информацией о слотах
- Хранить в `extensionSettings`:
- `slots: []` - массив, где индекс = номер слота, значение = имя персонажа или undefined
- `slotsUsage: []` - массив счетчиков использования слотов (для выбора по частоте)

### 2. Перехват генерации и загрузка кеша

- **Файл**: `index.js`
- **Действия**:
- Подписаться на `event_types.GENERATE_BEFORE_COMBINE_PROMPTS` с асинхронным обработчиком
- В обработчике:
- Получить имя персонажа из `data.char`
- Проверить, прикреплен ли персонаж к слоту (проверить `extensionSettings.slots`)
- Если персонаж не прикреплен:
- Найти последний сохраненный кеш через `getLastCacheForCharacter()`
- Если кеш найден:
  - Выбрать слот для вытеснения через `acquireSlot()` (по частоте использования)
  - Сохранить текущий кеш вытесняемого слота (если есть персонаж в слоте)
  - Загрузить кеш персонажа через `loadSlotCache()`
  - Прикрепить персонажа к слоту
- Если кеш не найден, просто прикрепить к свободному/вытесняемому слоту
- Сохранить текущий слот в переменную для использования в `TEXT_COMPLETION_SETTINGS_READY`
- В обработчике `event_types.TEXT_COMPLETION_SETTINGS_READY`:
- Установить `params["id_slot"]` из сохраненного слота персонажа

### 3. Функция поиска кеша по имени персонажа

- **Файл**: `index.js`
- **Действия**:
- Создать функцию `getLastCacheForCharacter(characterName)`:
- Получить список всех файлов через `getFilesList()`
- Найти файлы, содержащие имя персонажа в части `userName` при парсинге через `parseSaveFilename()`
- Если не найдено по `userName`, попробовать найти по имени файла (нормализовать имя персонажа)
- Вернуть самый последний файл (по timestamp) для этого персонажа
- Вернуть объект с `filename` и `slotId` (из парсинга имени файла)

### 4. Кнопка предзагрузки всех персонажей группы

- **Файл**: `settings.html`
- **Действия**:
- Добавить кнопку "Предзагрузить всех персонажей группы" в секцию управления кешем
- **Файл**: `index.js`
- **Действия**:
- Импортировать `characters` из `script.js` (как в slot-manager-example.js)
- Создать функцию `preloadAllGroupCharacters()`:
- Получить список персонажей из глобального массива `characters`
- Для каждого персонажа:
- Найти его последний сохраненный кеш через `getLastCacheForCharacter()`
- Если кеш найден:
  - Выбрать свободный слот или вытеснить занятый (через `acquireSlot()`)
  - Загрузить кеш в слот через `loadSlotCache()`
  - Прикрепить персонажа к слоту
  - Увеличить счетчик использования слота
- Показать уведомление о количестве загруженных персонажей

### 5. UI для режима групповых чатов

- **Файл**: `settings.html`
- **Действия**:
- Добавить секцию "Режим групповых чатов":
- Чекбокс "Включить режим групповых чатов"
- Индикатор занятых/свободных слотов
- Кнопка "Предзагрузить всех персонажей группы"
- Кнопка "Освободить все слоты"

## Технические детали

### Инициализация слотов

- При первом запуске или при событии `APP_READY` вызвать `initializeSlots()`
- Получить количество слотов через `getAllSlotsInfo()` и `getSlotsCountFromData()`

### Логика выбора слота (по частоте использования)

- Если персонаж уже прикреплен - вернуть его слот и увеличить счетчик использования
- Если есть свободный слот - использовать его
- Если все слоты заняты - найти слот с наименьшим счетчиком использования в `slotsUsage[index]`

### Сохранение кеша перед вытеснением

- Перед загрузкой нового кеша в занятый слот:
- Сохранить текущий кеш слота через `saveSlotCache()` с автоматическим именем
- Очистить слот через `clearSlotCache()` (опционально, т.к. restore перезапишет)

### Обработка ошибок

- При ошибке загрузки кеша - продолжить генерацию без кеша
- Логировать все операции для отладки

### Примечание о генерации

- Генерация не останавливается явно - обработчик `GENERATE_BEFORE_COMBINE_PROMPTS` выполняется асинхронно, загружает кеш, и затем в `TEXT_COMPLETION_SETTINGS_READY` устанавливается `id_slot`, что позволяет использовать загруженный кеш

## Файлы для изменения

1. `index.js` - основная логика
2. `settings.html` - UI элементы
3. `manifest.json` - возможно обновить версию

## Зависимости

- Использование существующих функций: `getFilesList()`, `loadSlotCache()`, `saveSlotCache()`, `getAllSlotsInfo()`, `parseSaveFilename()`
- Использование событий SillyTavern: `GENERATE_BEFORE_COMBINE_PROMPTS`, `TEXT_COMPLETION_SETTINGS_READY`, `APP_READY`
- Импорт глобальных переменных: `characters` из `script.js` (как в slot-manager-example.js), `eventSource`, `event_types`

### To-dos

- [ ] Добавить настройки режима групповых чатов в defaultSettings и loadSettings()
- [ ] Реализовать функции отслеживания слотов: initializeSlots(), acquireSlot(), releaseSlot(), updateSlotsAvailability()
- [ ] Реализовать функцию поиска последнего кеша для персонажа getLastCacheForCharacter()
- [ ] Реализовать перехват GENERATE_BEFORE_COMBINE_PROMPTS с логикой загрузки кеша
- [ ] Обновить обработчик TEXT_COMPLETION_SETTINGS_READY для установки id_slot из прикрепленного слота
- [ ] Добавить UI элементы в settings.html (чекбокс режима, индикатор слотов, кнопки)
- [ ] Реализовать функцию предзагрузки всех персонажей группы preloadAllGroupCharacters()
- [ ] Добавить обработчики событий и инициализацию при APP_READY